<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>IoT Power Consumption - Practical MongoDB Aggregations Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="Learn about MongoDB Aggregations to develop effective and optimal data manipulation and analytics aggregation pipelines with this book, using the MongoDB Aggregation Framework (aggregate)">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-D0T2GQ8R19"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-D0T2GQ8R19');
        </script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../front-cover.html">Practical MongoDB Aggregations</a></li><li class="chapter-item expanded affix "><a href="../../credits.html">Credits</a></li><li class="chapter-item expanded affix "><a href="../../foreword.html">Foreword</a></li><li class="chapter-item expanded affix "><a href="../../who-this-is-for.html">Who This Book Is For</a></li><li class="chapter-item expanded "><a href="../../intro/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../intro/introducing-aggregations.html"><strong aria-hidden="true">1.1.</strong> Introducing MongoDB Aggregations</a></li><li class="chapter-item expanded "><a href="../../intro/history.html"><strong aria-hidden="true">1.2.</strong> History of MongoDB Aggregations</a></li><li class="chapter-item expanded "><a href="../../intro/getting-started.html"><strong aria-hidden="true">1.3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../../intro/getting-help.html"><strong aria-hidden="true">1.4.</strong> Getting Help</a></li></ol></li><li class="chapter-item expanded "><a href="../../guides/guides.html"><strong aria-hidden="true">2.</strong> Guiding Tips & Principles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../guides/composibility.html"><strong aria-hidden="true">2.1.</strong> Embrace Composability For Increased Productivity</a></li><li class="chapter-item expanded "><a href="../../guides/project.html"><strong aria-hidden="true">2.2.</strong> Better Alternatives To A Project Stage</a></li><li class="chapter-item expanded "><a href="../../guides/explain.html"><strong aria-hidden="true">2.3.</strong> Using Explain Plans</a></li><li class="chapter-item expanded "><a href="../../guides/performance.html"><strong aria-hidden="true">2.4.</strong> Pipeline Performance Considerations</a></li><li class="chapter-item expanded "><a href="../../guides/expressions.html"><strong aria-hidden="true">2.5.</strong> Expressions Explained</a></li><li class="chapter-item expanded "><a href="../../guides/sharding.html"><strong aria-hidden="true">2.6.</strong> Sharding Considerations</a></li><li class="chapter-item expanded "><a href="../../guides/advanced-arrays.html"><strong aria-hidden="true">2.7.</strong> Advanced Use Of Expressions For Array Processing</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/examples.html"><strong aria-hidden="true">3.</strong> Aggregations By Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/foundational/foundational.html"><strong aria-hidden="true">3.1.</strong> Foundational Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/foundational/filtered-top-subset.html"><strong aria-hidden="true">3.1.1.</strong> Filtered Top Subset</a></li><li class="chapter-item expanded "><a href="../../examples/foundational/group-and-total.html"><strong aria-hidden="true">3.1.2.</strong> Group & Total</a></li><li class="chapter-item expanded "><a href="../../examples/foundational/unpack-array-group-differently.html"><strong aria-hidden="true">3.1.3.</strong> Unpack Arrays & Group Differently</a></li><li class="chapter-item expanded "><a href="../../examples/foundational/distinct-values.html"><strong aria-hidden="true">3.1.4.</strong> Distinct List Of Values</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/joining/joining.html"><strong aria-hidden="true">3.2.</strong> Joining Data Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/joining/one-to-one-join.html"><strong aria-hidden="true">3.2.1.</strong> One-to-One Join</a></li><li class="chapter-item expanded "><a href="../../examples/joining/multi-one-to-many.html"><strong aria-hidden="true">3.2.2.</strong> Multi-Field Join & One-to-Many</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/type-convert/type-convert.html"><strong aria-hidden="true">3.3.</strong> Data Types Conversion Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/type-convert/convert-to-strongly-typed.html"><strong aria-hidden="true">3.3.1.</strong> Strongly-Typed Conversion</a></li><li class="chapter-item expanded "><a href="../../examples/type-convert/convert-incomplete-dates.html"><strong aria-hidden="true">3.3.2.</strong> Convert Incomplete Date Strings</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/trend-analysis/trend-analysis.html"><strong aria-hidden="true">3.4.</strong> Trend Analysis Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/trend-analysis/faceted-classifications.html"><strong aria-hidden="true">3.4.1.</strong> Faceted Classification</a></li><li class="chapter-item expanded "><a href="../../examples/trend-analysis/largest-graph-network.html"><strong aria-hidden="true">3.4.2.</strong> Largest Graph Network</a></li><li class="chapter-item expanded "><a href="../../examples/trend-analysis/incremental-analytics.html"><strong aria-hidden="true">3.4.3.</strong> Incremental Analytics</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/securing-data/securing-data.html"><strong aria-hidden="true">3.5.</strong> Securing Data Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/securing-data/redacted-view.html"><strong aria-hidden="true">3.5.1.</strong> Redacted View</a></li><li class="chapter-item expanded "><a href="../../examples/securing-data/mask-sensitive-fields.html"><strong aria-hidden="true">3.5.2.</strong> Mask Sensitive Fields</a></li><li class="chapter-item expanded "><a href="../../examples/securing-data/role-programmatic-restricted-view.html"><strong aria-hidden="true">3.5.3.</strong> Role Programmatic Restricted View</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/time-series/time-series.html"><strong aria-hidden="true">3.6.</strong> Time-Series Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/time-series/iot-power-consumption.html" class="active"><strong aria-hidden="true">3.6.1.</strong> IoT Power Consumption</a></li><li class="chapter-item expanded "><a href="../../examples/time-series/state-change-boundaries.html"><strong aria-hidden="true">3.6.2.</strong> State Change Boundaries</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-manipulations.html"><strong aria-hidden="true">3.7.</strong> Array Manipulation Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-high-low-avg.html"><strong aria-hidden="true">3.7.1.</strong> Summarising Arrays For First, Last, Min, Max & Average</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/pivot-array-items.html"><strong aria-hidden="true">3.7.2.</strong> Pivot Array Items By A Key</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-sort-percentiles.html"><strong aria-hidden="true">3.7.3.</strong> Array Sorting & Percentiles</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-element-grouping.html"><strong aria-hidden="true">3.7.4.</strong> Array Element Grouping</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-fields-joining.html"><strong aria-hidden="true">3.7.5.</strong> Array Fields Joining</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/comparison-of-two-arrays.html"><strong aria-hidden="true">3.7.6.</strong> Comparison Of Two Arrays</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/full-text-search/full-text-search.html"><strong aria-hidden="true">3.8.</strong> Full Text Search Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/full-text-search/compound-text-search.html"><strong aria-hidden="true">3.8.1.</strong> Compound Text Search Criteria</a></li><li class="chapter-item expanded "><a href="../../examples/full-text-search/facets-and-counts-text-search.html"><strong aria-hidden="true">3.8.2.</strong> Facets And Counts Text Search</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../appendices/appendices.html"><strong aria-hidden="true">4.</strong> Appendices</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../appendices/cheatsheet.html"><strong aria-hidden="true">4.1.</strong> Appendix: Stages Cheatsheet</a></li><li class="chapter-item expanded "><a href="../../appendices/cheatsheet-source.html"><strong aria-hidden="true">4.2.</strong> Appendix: Stages Cheatsheet Source</a></li><li class="chapter-item expanded "><a href="../../appendices/create-search-index.html"><strong aria-hidden="true">4.3.</strong> Appendix: Create Atlas Search Index</a></li><li class="chapter-item expanded "><a href="../../appendices/book-history.html"><strong aria-hidden="true">4.4.</strong> Appendix: Book Version History</a></li></ol></li><li class="chapter-item expanded "><a href="../../back-cover.html"></a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Practical MongoDB Aggregations Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="iot-power-consumption"><a class="header" href="#iot-power-consumption">IoT Power Consumption</a></h1>
<p><strong>Minimum MongoDB Version:</strong> 5.0    <em>(due to use of <a href="https://docs.mongodb.com/manual/core/timeseries-collections/">time series collections</a>, <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/setWindowFields/"><code>$setWindowFields</code></a> stage &amp; <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/integral/"><code>$integral</code></a> operator)</em></p>
<h2 id="scenario"><a class="header" href="#scenario">Scenario</a></h2>
<p>You are monitoring various air-conditioning units running in two buildings on an industrial campus. Every 30 minutes, a device in each unit sends the unit's current power consumption reading back to base, which a central database persists. You want to analyse this data to see how much energy in kilowatt-hours (kWh) each air-conditioning unit has consumed over the last hour for each reading received. Furthermore, you want to compute the total energy consumed by all the air-conditioning units combined in each building for every hour.</p>
<h2 id="sample-data-population"><a class="header" href="#sample-data-population">Sample Data Population</a></h2>
<p>Drop any old version of the database (if it exists) and then populate a new <code>device_readings</code> collection with device readings spanning 3 hours of a day for air-conditioning units in two different buildings.</p>
<pre><code class="language-javascript">db = db.getSiblingDB(&quot;book-iot-power-consumption&quot;);
db.dropDatabase();

// Use a time-series collection for optimal processing
// NOTE: This command can be commented out and the full example will still work
db.createCollection(&quot;device_readings&quot;, {
  &quot;timeseries&quot;: {
    &quot;timeField&quot;: &quot;timestamp&quot;,
    &quot;metaField&quot;: &quot;deviceID&quot;,
    &quot;granularity&quot;: &quot;minutes&quot;
  }
});

// Create compound index to aid performance for partitionBy &amp; sortBy of setWindowFields
db.device_readings.createIndex({&quot;deviceID&quot;: 1, &quot;timestamp&quot;: 1});

// Insert 18 records into the device readings collection
db.device_readings.insertMany([
  // 11:29am device readings
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;, 
    &quot;deviceID&quot;: &quot;UltraAirCon-111&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T11:29:59Z&quot;),
    &quot;powerKilowatts&quot;: 8,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-222&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T11:29:59Z&quot;),
    &quot;powerKilowatts&quot;: 7,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-XYZ&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-666&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T11:29:59Z&quot;),
    &quot;powerKilowatts&quot;: 10,     
  },
  
  // 11:59am device readings
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-222&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T11:59:59Z&quot;),
    &quot;powerKilowatts&quot;: 9,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-111&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T11:59:59Z&quot;),
    &quot;powerKilowatts&quot;: 8,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-XYZ&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-666&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T11:59:59Z&quot;),
    &quot;powerKilowatts&quot;: 11,     
  },
  
  // 12:29pm device readings
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-222&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T12:29:59Z&quot;),
    &quot;powerKilowatts&quot;: 9,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-111&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T12:29:59Z&quot;),
    &quot;powerKilowatts&quot;: 9,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-XYZ&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-666&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T12:29:59Z&quot;),
    &quot;powerKilowatts&quot;: 10,     
  },

  // 12:59pm device readings
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-222&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T12:59:59Z&quot;),
    &quot;powerKilowatts&quot;: 8,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-111&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T12:59:59Z&quot;),
    &quot;powerKilowatts&quot;: 8,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-XYZ&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-666&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T12:59:59Z&quot;),
    &quot;powerKilowatts&quot;: 11,     
  },

  // 13:29pm device readings
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-222&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T13:29:59Z&quot;),
    &quot;powerKilowatts&quot;: 9,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-111&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T13:29:59Z&quot;),
    &quot;powerKilowatts&quot;: 9,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-XYZ&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-666&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T13:29:59Z&quot;),
    &quot;powerKilowatts&quot;: 10,     
  },

  // 13:59pm device readings
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-222&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T13:59:59Z&quot;),
    &quot;powerKilowatts&quot;: 8,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-ABC&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-111&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T13:59:59Z&quot;),
    &quot;powerKilowatts&quot;: 8,     
  },
  {
    &quot;buildingID&quot;: &quot;Building-XYZ&quot;,
    &quot;deviceID&quot;: &quot;UltraAirCon-666&quot;,    
    &quot;timestamp&quot;: ISODate(&quot;2021-07-03T13:59:59Z&quot;),
    &quot;powerKilowatts&quot;: 11,     
  },
]);
</code></pre>
<h2 id="aggregation-pipeline"><a class="header" href="#aggregation-pipeline">Aggregation Pipeline</a></h2>
<p>Define a pipeline ready to perform an aggregation to calculate the energy an air-conditioning unit has consumed over the last hour for each reading received:</p>
<pre><code class="language-javascript">var pipelineRawReadings = [
  // Calculate each unit's energy consumed over the last hour for each reading
  {&quot;$setWindowFields&quot;: {
    &quot;partitionBy&quot;: &quot;$deviceID&quot;,
    &quot;sortBy&quot;: {&quot;timestamp&quot;: 1},    
    &quot;output&quot;: {
      &quot;consumedKilowattHours&quot;: {
        &quot;$integral&quot;: {
          &quot;input&quot;: &quot;$powerKilowatts&quot;,
          &quot;unit&quot;: &quot;hour&quot;,
        },
        &quot;window&quot;: {
          &quot;range&quot;: [-1, &quot;current&quot;],
          &quot;unit&quot;: &quot;hour&quot;,
        },
      },
    },
  }},
];
</code></pre>
<p>Define a pipeline ready to compute the total energy consumed by all the air-conditioning units combined in each building for every hour:</p>
<pre><code class="language-javascript">var pipelineBuildingsSummary = [
  // Calculate each unit's energy consumed over the last hour for each reading
  {&quot;$setWindowFields&quot;: {
    &quot;partitionBy&quot;: &quot;$deviceID&quot;,
    &quot;sortBy&quot;: {&quot;timestamp&quot;: 1},    
    &quot;output&quot;: {
      &quot;consumedKilowattHours&quot;: {
        &quot;$integral&quot;: {
          &quot;input&quot;: &quot;$powerKilowatts&quot;,
          &quot;unit&quot;: &quot;hour&quot;,
        },
        &quot;window&quot;: {
          &quot;range&quot;: [-1, &quot;current&quot;],
          &quot;unit&quot;: &quot;hour&quot;,
        },
      },
    },
  }},
  
  // Sort each reading by unit/device and then by timestamp
  {&quot;$sort&quot;: {
    &quot;deviceID&quot;: 1,
    &quot;timestamp&quot;: 1,
  }},    
  
  // Group readings together for each hour for each device using
  // the last calculated energy consumption field for each hour
  {&quot;$group&quot;: {
    &quot;_id&quot;: {
      &quot;deviceID&quot;: &quot;$deviceID&quot;,
      &quot;date&quot;: {
          &quot;$dateTrunc&quot;: {
            &quot;date&quot;: &quot;$timestamp&quot;,
            &quot;unit&quot;: &quot;hour&quot;,
          }
      },
    },
    &quot;buildingID&quot;: {&quot;$last&quot;: &quot;$buildingID&quot;},
    &quot;consumedKilowattHours&quot;: {&quot;$last&quot;: &quot;$consumedKilowattHours&quot;},
  }},    

  // Sum together the energy consumption for the whole building
  // for each hour across all the units in the building   
  {&quot;$group&quot;: {
    &quot;_id&quot;: {
      &quot;buildingID&quot;: &quot;$buildingID&quot;,
      &quot;dayHour&quot;: {&quot;$dateToString&quot;: {&quot;format&quot;: &quot;%Y-%m-%d  %H&quot;, &quot;date&quot;: &quot;$_id.date&quot;}},
    },
    &quot;consumedKilowattHours&quot;: {&quot;$sum&quot;: &quot;$consumedKilowattHours&quot;},
  }},    

  // Sort the results by each building and then by each hourly summary
  {&quot;$sort&quot;: {
    &quot;_id.buildingID&quot;: 1,
    &quot;_id.dayHour&quot;: 1,
  }},    

  // Make the results more presentable with meaningful field names
  {&quot;$set&quot;: {
    &quot;buildingID&quot;: &quot;$_id.buildingID&quot;,
    &quot;dayHour&quot;: &quot;$_id.dayHour&quot;,
    &quot;_id&quot;: &quot;$$REMOVE&quot;,
  }},      
];
</code></pre>
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<p>Execute an aggregation using the pipeline to calculate the energy an air-conditioning unit has consumed over the last hour for each reading received and also view its explain plan:</p>
<pre><code class="language-javascript">db.device_readings.aggregate(pipelineRawReadings);
</code></pre>
<pre><code class="language-javascript">db.device_readings.explain(&quot;executionStats&quot;).aggregate(pipelineRawReadings);
</code></pre>
<p>Execute an aggregation using the pipeline to compute the total energy consumed by all the air-conditioning units combined in each building for every hour and also view its explain plan:</p>
<pre><code class="language-javascript">db.device_readings.aggregate(pipelineBuildingsSummary);
</code></pre>
<pre><code class="language-javascript">db.device_readings.explain(&quot;executionStats&quot;).aggregate(pipelineBuildingsSummary);
</code></pre>
<h2 id="expected-results"><a class="header" href="#expected-results">Expected Results</a></h2>
<p>For the pipeline to calculate the energy an air-conditioning unit has consumed over the last hour for each reading received, results like the following should be returned (redacted for brevity - only showing the first few records):</p>
<pre><code class="language-javascript">[
  {
    _id: ObjectId(&quot;60ed5e679ea1f9f74814ca2b&quot;),
    buildingID: 'Building-ABC',
    deviceID: 'UltraAirCon-111',
    timestamp: ISODate(&quot;2021-07-03T11:29:59.000Z&quot;),
    powerKilowatts: 8,
    consumedKilowattHours: 0
  },
  {
    _id: ObjectId(&quot;60ed5e679ea1f9f74814ca2f&quot;),
    buildingID: 'Building-ABC',
    deviceID: 'UltraAirCon-111',
    timestamp: ISODate(&quot;2021-07-03T11:59:59.000Z&quot;),
    powerKilowatts: 8,
    consumedKilowattHours: 4
  },
  {
    _id: ObjectId(&quot;60ed5e679ea1f9f74814ca32&quot;),
    buildingID: 'Building-ABC',
    deviceID: 'UltraAirCon-111',
    timestamp: ISODate(&quot;2021-07-03T12:29:59.000Z&quot;),
    powerKilowatts: 9,
    consumedKilowattHours: 8.25
  },
  {
    _id: ObjectId(&quot;60ed5e679ea1f9f74814ca35&quot;),
    buildingID: 'Building-ABC',
    deviceID: 'UltraAirCon-111',
    timestamp: ISODate(&quot;2021-07-03T12:59:59.000Z&quot;),
    powerKilowatts: 8,
    consumedKilowattHours: 8.5
  },
  {
    _id: ObjectId(&quot;60ed5e679ea1f9f74814ca38&quot;),
    buildingID: 'Building-ABC',
    deviceID: 'UltraAirCon-111',
    timestamp: ISODate(&quot;2021-07-03T13:29:59.000Z&quot;),
    powerKilowatts: 9,
    consumedKilowattHours: 8.5
  },
  ...
  ...
]
</code></pre>
<p>For the pipeline to compute the total energy consumed by all the air-conditioning units combined in each building for every hour, the following results should be returned:</p>
<pre><code class="language-javascript">[
  {
    buildingID: 'Building-ABC',
    dayHour: '2021-07-03  11',
    consumedKilowattHours: 8
  },
  {
    buildingID: 'Building-ABC',
    dayHour: '2021-07-03  12',
    consumedKilowattHours: 17.25
  },
  {
    buildingID: 'Building-ABC',
    dayHour: '2021-07-03  13',
    consumedKilowattHours: 17
  },
  {
    buildingID: 'Building-XYZ',
    dayHour: '2021-07-03  11',
    consumedKilowattHours: 5.25
  },
  {
    buildingID: 'Building-XYZ',
    dayHour: '2021-07-03  12',
    consumedKilowattHours: 10.5
  },
  {
    buildingID: 'Building-XYZ',
    dayHour: '2021-07-03  13',
    consumedKilowattHours: 10.5
  }
]
</code></pre>
<h2 id="observations"><a class="header" href="#observations">Observations</a></h2>
<ul>
<li>
<p><strong>Integral Trapezoidal Rule.</strong> As <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/integral/">documented in the MongoDB Manual</a>, <code>$integral</code> <em>&quot;returns an approximation for the mathematical integral value, which is calculated using the trapezoidal rule&quot;</em>. For non-mathematicians, this explanation may be hard to understand. You may find it easier to comprehend the behaviour of the <code>$integral</code> operator by studying the illustration below and the explanation that follows:</p>
<p><img src="./pics/trapezoidal-rule-example.png" alt="Example of calculating power consumption by approximating integrals using the trapezoidal rule" /></p>
<p>Essentially the <a href="https://en.wikipedia.org/wiki/Trapezoidal_rule">trapezoidal rule</a> determines the area of a region between two points under a graph by matching the region with a trapezoid shape that approximately fits this region and then calculating the area of this trapezoid. You can see a set of points on the illustrated graph with the matched trapezoid shape underneath each pair of points. For this IoT Power Consumption example, the points on the graph represent an air-conditioning unit's power readings captured every 30 minutes. The Y-axis is the <em>power rate</em> in Kilowatts, and the X-axis is <em>time</em> to indicate when the device captured each reading. Consequently, for this example, the energy consumed by the air-conditioning unit for a given hour's span is the area of the hour's specific section under the graph. This section's area is approximately the area of the two trapezoids shown. Using the <code>$integral</code> operator for the window of time you define in the <code>$setWindowFields</code> stage, you are asking for this approximate area to be calculated, which is the Kilowatt-hours consumed by the air-conditioning unit in one hour.</p>
</li>
<li>
<p><strong>Window Range Definition.</strong> For every captured document representing a device reading, this example's pipeline identifies a window of <em>1-hour</em> of previous documents relative to this <em>current</em> document. The pipeline uses this set of documents as the input for the <code>$integral</code> operator. It defines this window range in the setting <code>range: [-1, &quot;current&quot;], unit: &quot;hour&quot;</code>. The pipeline assigns the output of the <code>$integral</code> calculation to a new field called <code>consumedKilowattHours</code>.</p>
</li>
<li>
<p><strong>One Hour Range Vs Hours Output.</strong> The fact that the <code>$setWindowFields</code> stage in the pipeline defines <code>unit: &quot;hour&quot;</code> in two places may appear redundant at face value. However, this is not the case, and each serves a different purpose. As described in the previous observation, <code>unit: &quot;hour&quot;</code> for the <code>&quot;window&quot;</code> option helps dictate the size of the window of the previous number of documents to analyse. However, <code>unit: &quot;hour&quot;</code> for the <code>$integral</code> operator defines that the output should be in hours (&quot;Kilowatt-hours&quot; in this example), yielding the result <code>consumedKilowattHours: 8.5</code> for one of the processed device readings. However, if the pipeline defined this <code>$integral</code> parameter to be <code>&quot;unit&quot;: &quot;minute&quot;</code> instead, which is perfectly valid, the output value would be <code>510</code> Kilowatt-minutes (i.e. 8.5 x 60 minutes).</p>
</li>
<li>
<p><strong>Optional Time Series Collection.</strong> This example uses a <a href="https://docs.mongodb.com/manual/core/timeseries-collections/">time series collection</a> to store sequences of device measurements over time efficiently. Employing a time series collection is optional, as shown in the <code>NOTE</code> Javascript comment in the example code. The aggregation pipeline does not need to be changed and achieves the same output if you use a regular collection instead. However, when dealing with large data sets, the aggregation will complete quicker by employing a time series collection.</p>
</li>
<li>
<p><strong>Index For Partition By &amp; Sort By.</strong> In this example, you define the index <code>{deviceID: 1, timestamp: 1}</code> to optimise the use of the combination of the <code>partitionBy</code> and <code>sortBy</code> parameters in the <code>$setWindowFields</code> stage. This means that the aggregation runtime does not have to perform a slow in-memory sort based on these two fields, and it also avoids the pipeline stage memory limit of 100 MB. It is beneficial to use this index regardless of whether you employ a regular collection or adopt a time series collection.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../examples/time-series/time-series.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../examples/time-series/state-change-boundaries.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../examples/time-series/time-series.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../examples/time-series/state-change-boundaries.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
