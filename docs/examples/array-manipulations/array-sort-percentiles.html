<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Array Sorting &amp; Percentiles - Practical MongoDB Aggregations Book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Learn how to develop effective and optimal data manipulation and analytics pipelines with this book, using the MongoDB Aggregation Framework">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-D0T2GQ8R19"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-D0T2GQ8R19');
        </script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../front-cover.html">Practical MongoDB Aggregations</a></li><li class="chapter-item expanded affix "><a href="../../credits.html">Credits</a></li><li class="chapter-item expanded affix "><a href="../../foreword.html">Foreword</a></li><li class="chapter-item expanded affix "><a href="../../who-this-is-for.html">Who This Book Is For</a></li><li class="chapter-item expanded "><a href="../../intro/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../intro/introducing-aggregations.html"><strong aria-hidden="true">1.1.</strong> Introducing MongoDB Aggregations</a></li><li class="chapter-item expanded "><a href="../../intro/history.html"><strong aria-hidden="true">1.2.</strong> History of MongoDB Aggregations</a></li><li class="chapter-item expanded "><a href="../../intro/getting-started.html"><strong aria-hidden="true">1.3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../../intro/getting-help.html"><strong aria-hidden="true">1.4.</strong> Getting Help</a></li></ol></li><li class="chapter-item expanded "><a href="../../guides/guides.html"><strong aria-hidden="true">2.</strong> Guiding Tips &amp; Principles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../guides/composibility.html"><strong aria-hidden="true">2.1.</strong> Embrace Composability For Increased Productivity</a></li><li class="chapter-item expanded "><a href="../../guides/project.html"><strong aria-hidden="true">2.2.</strong> Better Alternatives To A Project Stage</a></li><li class="chapter-item expanded "><a href="../../guides/explain.html"><strong aria-hidden="true">2.3.</strong> Using Explain Plans</a></li><li class="chapter-item expanded "><a href="../../guides/performance.html"><strong aria-hidden="true">2.4.</strong> Pipeline Performance Considerations</a></li><li class="chapter-item expanded "><a href="../../guides/expressions.html"><strong aria-hidden="true">2.5.</strong> Expressions Explained</a></li><li class="chapter-item expanded "><a href="../../guides/sharding.html"><strong aria-hidden="true">2.6.</strong> Sharding Considerations</a></li><li class="chapter-item expanded "><a href="../../guides/advanced-arrays.html"><strong aria-hidden="true">2.7.</strong> Advanced Use Of Expressions For Array Processing</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/examples.html"><strong aria-hidden="true">3.</strong> Aggregations By Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/foundational/foundational.html"><strong aria-hidden="true">3.1.</strong> Foundational Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/foundational/filtered-top-subset.html"><strong aria-hidden="true">3.1.1.</strong> Filtered Top Subset</a></li><li class="chapter-item expanded "><a href="../../examples/foundational/group-and-total.html"><strong aria-hidden="true">3.1.2.</strong> Group &amp; Total</a></li><li class="chapter-item expanded "><a href="../../examples/foundational/unpack-array-group-differently.html"><strong aria-hidden="true">3.1.3.</strong> Unpack Arrays &amp; Group Differently</a></li><li class="chapter-item expanded "><a href="../../examples/foundational/distinct-values.html"><strong aria-hidden="true">3.1.4.</strong> Distinct List Of Values</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/joining/joining.html"><strong aria-hidden="true">3.2.</strong> Joining Data Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/joining/one-to-one-join.html"><strong aria-hidden="true">3.2.1.</strong> One-to-One Join</a></li><li class="chapter-item expanded "><a href="../../examples/joining/multi-one-to-many.html"><strong aria-hidden="true">3.2.2.</strong> Multi-Field Join &amp; One-to-Many</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/type-convert/type-convert.html"><strong aria-hidden="true">3.3.</strong> Data Types Conversion Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/type-convert/convert-to-strongly-typed.html"><strong aria-hidden="true">3.3.1.</strong> Strongly-Typed Conversion</a></li><li class="chapter-item expanded "><a href="../../examples/type-convert/convert-incomplete-dates.html"><strong aria-hidden="true">3.3.2.</strong> Convert Incomplete Date Strings</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/trend-analysis/trend-analysis.html"><strong aria-hidden="true">3.4.</strong> Trend Analysis Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/trend-analysis/faceted-classifications.html"><strong aria-hidden="true">3.4.1.</strong> Faceted Classification</a></li><li class="chapter-item expanded "><a href="../../examples/trend-analysis/largest-graph-network.html"><strong aria-hidden="true">3.4.2.</strong> Largest Graph Network</a></li><li class="chapter-item expanded "><a href="../../examples/trend-analysis/incremental-analytics.html"><strong aria-hidden="true">3.4.3.</strong> Incremental Analytics</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/securing-data/securing-data.html"><strong aria-hidden="true">3.5.</strong> Securing Data Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/securing-data/restricted-view.html"><strong aria-hidden="true">3.5.1.</strong> Restricted View</a></li><li class="chapter-item expanded "><a href="../../examples/securing-data/mask-sensitive-fields.html"><strong aria-hidden="true">3.5.2.</strong> Mask Sensitive Fields</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/time-series/time-series.html"><strong aria-hidden="true">3.6.</strong> Time-Series Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/time-series/iot-power-consumption.html"><strong aria-hidden="true">3.6.1.</strong> IoT Power Consumption</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-manipulations.html"><strong aria-hidden="true">3.7.</strong> Array Manipulation Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-high-low-avg.html"><strong aria-hidden="true">3.7.1.</strong> Summarising Arrays For First, Last, Min, Max &amp; Average</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/pivot-array-items.html"><strong aria-hidden="true">3.7.2.</strong> Pivot Array Items By A Key</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-sort-percentiles.html" class="active"><strong aria-hidden="true">3.7.3.</strong> Array Sorting &amp; Percentiles</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../appendices/appendices.html"><strong aria-hidden="true">4.</strong> Appendices</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../appendices/cheatsheet.html"><strong aria-hidden="true">4.1.</strong> Appendix: Stages Cheatsheet</a></li><li class="chapter-item expanded "><a href="../../appendices/cheatsheet-source.html"><strong aria-hidden="true">4.2.</strong> Appendix: Stages Cheatsheet Source</a></li><li class="chapter-item expanded "><a href="../../appendices/book-history.html"><strong aria-hidden="true">4.3.</strong> Appendix: Book Version History</a></li></ol></li><li class="chapter-item expanded "><a href="../../back-cover.html"></a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Practical MongoDB Aggregations Book</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="array-sorting--percentiles"><a class="header" href="#array-sorting--percentiles">Array Sorting &amp; Percentiles</a></h1>
<p><strong>Minimum MongoDB Version:</strong> 4.2</p>
<h2 id="scenario"><a class="header" href="#scenario">Scenario</a></h2>
<p>You have been conducting performance testing of an application's API with the results of each &quot;test run&quot; captured in a document in a database. Each &quot;test run&quot; document contains an array of multiple response times that the test recorded during its execution. You need to analyse the recorded data to identify the slow tests. To achieve this, you want to calculate the <a href="https://en.wikipedia.org/wiki/Median">median</a> (50th percentile) and 90th <a href="https://en.wikipedia.org/wiki/Percentile">percentile</a> response times for each recorded &quot;test run&quot; and then only keep documents where the 90th percentile response time is greater than 100 milliseconds.</p>
<blockquote>
<p><em>This example chapter uses a slightly modified version of an &quot;expression generator&quot; <a href="https://github.com/asya999/bits-n-pieces/blob/master/scripts/sortArray.js">macro function for inline sorting of arrays</a> created by <a href="https://twitter.com/asya999">Asya Kamsky</a>. Adopting this approach avoids the need for you to use the combination of <code>$unwind</code>, <code>$sort</code>, and <code>$group</code> stages. Instead, you process each document's array in isolation for <a href="../../guides/performance.html#2-avoid-unwinding--regrouping-documents-just-to-process-array-elements">optimum performance</a>. You can re-use this chapter's <code>sortArray()</code> function as-is for your own situations where you need to sort an array field's contents.</em></p>
</blockquote>
<h2 id="sample-data-population"><a class="header" href="#sample-data-population">Sample Data Population</a></h2>
<p>Drop any old version of the database (if it exists) and then populate the test run results documents:</p>
<pre><code class="language-javascript">use book-inline-array-sort-percentile;
db.dropDatabase();

// Insert 7 records into the performance_test_results collection
db.performance_test_results.insertMany([
  {
    &quot;testRun&quot;: 1,
    &quot;datetime&quot;: ISODate(&quot;2021-08-01T22:51:27.638Z&quot;),
    &quot;responseTimesMillis&quot;: [
      62, 97, 59, 104, 97, 71, 62, 115, 82, 87,
    ],
  },
  {
    &quot;testRun&quot;: 2,
    &quot;datetime&quot;: ISODate(&quot;2021-08-01T22:56:32.272Z&quot;),
    &quot;responseTimesMillis&quot;: [
      34, 63, 51, 104, 87, 63, 64, 86, 105, 51, 73,
      78, 59, 108, 65, 58, 69, 106, 87, 93, 65,
    ],
  },
  {
    &quot;testRun&quot;: 3,
    &quot;datetime&quot;: ISODate(&quot;2021-08-01T23:01:08.908Z&quot;),
    &quot;responseTimesMillis&quot;: [
      56, 72, 83, 95, 107, 83, 85,
    ],
  },
  {
    &quot;testRun&quot;: 4,
    &quot;datetime&quot;: ISODate(&quot;2021-08-01T23:17:33.526Z&quot;),
    &quot;responseTimesMillis&quot;: [
      78, 67, 107, 110,
    ],
  },
  {
    &quot;testRun&quot;: 5,
    &quot;datetime&quot;: ISODate(&quot;2021-08-01T23:24:39.998Z&quot;),
    &quot;responseTimesMillis&quot;: [
      75, 91, 75, 87, 99, 88, 55, 72, 99, 102,
    ],
  },
  {
    &quot;testRun&quot;: 6,
    &quot;datetime&quot;: ISODate(&quot;2021-08-01T23:27:52.272Z&quot;),
    &quot;responseTimesMillis&quot;: [
      88, 89,
    ],
  },
  {
    &quot;testRun&quot;: 7,
    &quot;datetime&quot;: ISODate(&quot;2021-08-01T23:31:59.917Z&quot;),
    &quot;responseTimesMillis&quot;: [
      101,
    ],
  },
]);
</code></pre>
<h2 id="aggregation-pipeline"><a class="header" href="#aggregation-pipeline">Aggregation Pipeline</a></h2>
<p>Define the new <code>sortArray()</code> function for inline sorting of the contents of an array field, ready for you to use in a pipeline:</p>
<pre><code class="language-javascript">// Macro function to generate a complex aggregation expression for sorting an array
function sortArray(sourceArrayField) {
  return {
    // GENERATE BRAND NEW ARRAY TO CONTAIN THE ELEMENTS FROM SOURCE ARRAY BUT NOW SORTED
    &quot;$reduce&quot;: {
      &quot;input&quot;: sourceArrayField, 
      &quot;initialValue&quot;: [],  // THE FIRST VERSION OF TEMP SORTED ARRAY WILL BE EMPTY
      &quot;in&quot;: {
        &quot;$let&quot;: {
          &quot;vars&quot;: {  // CAPTURE $$this &amp; $$value FROM OUTER $reduce BEFORE OVERRIDDEN
            &quot;resultArray&quot;: &quot;$$value&quot;,
            &quot;currentSourceArrayElement&quot;: &quot;$$this&quot;
          },   
          &quot;in&quot;: {
            &quot;$let&quot;: {
              &quot;vars&quot;: { 
                // FIND EACH SOURCE ARRAY'S CURRENT ELEMENT POSITION IN NEW SORTED ARRAY
                &quot;targetArrayPosition&quot;: {
                  &quot;$reduce&quot;: { 
                    &quot;input&quot;: {&quot;$range&quot;: [0, {&quot;$size&quot;: &quot;$$resultArray&quot;}]},  // &quot;0,1,2..&quot;
                    &quot;initialValue&quot;: {  // INITIALISE SORTED POSITION TO BE LAST ARRAY ELEMENT
                      &quot;$size&quot;: &quot;$$resultArray&quot;
                    },
                    &quot;in&quot;: {  // LOOP THRU &quot;0,1,2...&quot;
                      &quot;$cond&quot;: [ 
                        {&quot;$lt&quot;: [
                          &quot;$$currentSourceArrayElement&quot;,
                          {&quot;$arrayElemAt&quot;: [&quot;$$resultArray&quot;, &quot;$$this&quot;]}
                        ]}, 
                        {&quot;$min&quot;: [&quot;$$value&quot;, &quot;$$this&quot;]},  // ONLY USE IF LOW VAL NOT YET FOUND
                        &quot;$$value&quot;  // RETAIN INITIAL VAL AGAIN AS NOT YET FOUND CORRECT POSTN
                      ]
                    }
                  }
                }
              },
              &quot;in&quot;: {
                // BUILD NEW SORTED ARRAY BY SLICING OLDER ONE &amp; INSERTING NEW ELEMENT BETWEEN
                &quot;$concatArrays&quot;: [
                  {&quot;$cond&quot;: [  // RETAIN THE EXISTING FIRST PART OF THE NEW ARRAY
                    {&quot;$eq&quot;: [0, &quot;$$targetArrayPosition&quot;]}, 
                    [],
                    {&quot;$slice&quot;: [&quot;$$resultArray&quot;, 0, &quot;$$targetArrayPosition&quot;]},
                  ]},
                  [&quot;$$currentSourceArrayElement&quot;],  // PULL IN THE NEW POSITIONED ELEMENT
                  {&quot;$cond&quot;: [  // RETAIN THE EXISTING LAST PART OF THE NEW ARRAY
                    {&quot;$gt&quot;: [{&quot;$size&quot;: &quot;$$resultArray&quot;}, 0]}, 
                    {&quot;$slice&quot;: [
                      &quot;$$resultArray&quot;,
                      &quot;$$targetArrayPosition&quot;,
                      {&quot;$size&quot;: &quot;$$resultArray&quot;}
                    ]},
                    [],
                  ]},
                ]
              } 
            }
          }
        }
      }
    }      
  };
}
</code></pre>
<p>Define the new arrayElemAtPercentile(n) function for capturing the element of a sorted array at the nth percentile position:</p>
<pre><code class="language-javascript">// Macro function to find nth percentile element of a sorted version of an array
function arrayElemAtPercentile(sourceArrayField, percentile) {
  return {    
    &quot;$let&quot;: {
      &quot;vars&quot;: {
        &quot;sortedArray&quot;: sortArray(sourceArrayField), 
      },
      &quot;in&quot;: {         
        &quot;$arrayElemAt&quot;: [  // FIND ELEMENT OF ARRAY AT NTH PERCENTILE POSITION
          &quot;$$sortedArray&quot;,
          {&quot;$subtract&quot;: [  // ARRAY IS 0-INDEX BASED SO SUBTRACT 1 TO GET POSITION
            {&quot;$ceil&quot;:  // FIND NTH ELEMENT IN THE ARRAY, ROUNDED UP TO NEAREST integer
              {&quot;$multiply&quot;: [
                {&quot;$divide&quot;: [percentile, 100]},
                {&quot;$size&quot;: &quot;$$sortedArray&quot;}
              ]}
            },
            1
          ]}
        ]
      }
    }
  };
}
</code></pre>
<p>Define the pipeline ready to perform the aggregation:</p>
<pre><code class="language-javascript">var pipeline = [
  // Capture new fields for the ordered array + various percentiles
  {&quot;$set&quot;: {
    &quot;sortedResponseTimesMillis&quot;: sortArray(&quot;$responseTimesMillis&quot;),
    &quot;medianTimeMillis&quot;: arrayElemAtPercentile(&quot;$responseTimesMillis&quot;, 50),
    &quot;ninetiethPercentileTimeMillis&quot;: arrayElemAtPercentile(&quot;$responseTimesMillis&quot;, 90),
  }},

  // Only show results for tests with slow latencies (i.e. 90th%-ile responses &gt;100ms)
  {&quot;$match&quot;: {
    &quot;ninetiethPercentileTimeMillis&quot;: {&quot;$gt&quot;: 100},
  }},

  // Exclude unrequired fields from each record
  {&quot;$unset&quot;: [
    &quot;_id&quot;,
    &quot;datetime&quot;,
    &quot;responseTimesMillis&quot;,
  ]},    
];
</code></pre>
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<p>Execute the aggregation using the defined pipeline and also view its explain plan:</p>
<pre><code class="language-javascript">db.performance_test_results.aggregate(pipeline);

db.performance_test_results.explain(&quot;executionStats&quot;).aggregate(pipeline);
</code></pre>
<h2 id="expected-results"><a class="header" href="#expected-results">Expected Results</a></h2>
<p>Five documents should be returned, representing the subset of documents with a 90th percentile response time greater than 100 milliseconds, as shown below:</p>
<pre><code class="language-javascript">[
  {
    testRun: 7,
    sortedResponseTimesMillis: [ 101 ],
    medianTimeMillis: 101,
    ninetiethPercentileTimeMillis: 101
  },
  {
    testRun: 1,
    sortedResponseTimesMillis: [
      59, 62, 62,  71,  82,
      87, 97, 97, 104, 115
    ],
    medianTimeMillis: 82,
    ninetiethPercentileTimeMillis: 104
  },
  {
    testRun: 2,
    sortedResponseTimesMillis: [
      34, 51, 51,  58,  59,  63,  63,
      64, 65, 65,  69,  73,  78,  86,
      87, 87, 93, 104, 105, 106, 108
    ],
    medianTimeMillis: 69,
    ninetiethPercentileTimeMillis: 105
  },
  {
    testRun: 3,
    sortedResponseTimesMillis: [
      56, 72,  83, 83,
      85, 95, 107
    ],
    medianTimeMillis: 83,
    ninetiethPercentileTimeMillis: 107
  },
  {
    testRun: 4,
    sortedResponseTimesMillis: [ 67, 78, 107, 110 ],
    medianTimeMillis: 78,
    ninetiethPercentileTimeMillis: 110
  }
]
</code></pre>
<h2 id="observations"><a class="header" href="#observations">Observations</a></h2>
<ul>
<li>
<p><strong>Macro Functions.</strong> In this chapter, you employ two functions, <code>sortArray()</code> and <code>arrayElemAtPercentile()</code>, to generate portions of aggregation <a href="https://en.wikipedia.org/wiki/Boilerplate_code">boilerplate code</a>. These functions are essentially <a href="https://en.wikipedia.org/wiki/Macro_(computer_science)">macros</a>. You invoke these functions from within the pipeline you create in the MongoDB Shell. Each function you invoke embeds the returned boilerplate code into the pipeline's code. You can see this in action by typing the text <code>pipeline</code> into the Shell and pressing <em>enter</em>. Note, you may first have to increase the depth displayed in <em>mongosh</em> by issuing the command <code>config.set(&quot;inspectDepth&quot;, 100)</code> in <em>mongosh</em>. This action will display a single large piece of code representing the whole pipeline, including the macro-generated code. The aggregation runtime never sees or runs the functions <code>sortArray()</code> and <code>arrayElemAtPercentile()</code> directly. Of course, you won't use JavaScript functions to generate composite expressions if you use a different programming language and <a href="https://docs.mongodb.com/drivers/">MongoDB Driver</a>. You will use the relevant features of your specific programming language to assemble composite expression objects.</p>
</li>
<li>
<p><strong>Sorting On Primitives Only.</strong> The sort function in this chapter will correctly sort arrays containing just primitive values, such as integers, floats, date-times and strings. However, if an array's members are objects (i.e. each has its own fields and values), the code will not sort the array correctly. It is possible to construct a function to enable the sorting of an array of objects, but such a function will be more complex and beyond the scope of this chapter.</p>
</li>
<li>
<p><strong>Comparison With Classic Sorting Algorithms.</strong> Despite being more optimal than unwinding and re-grouping arrays to bring them back into the same documents, the sorting code will be slow compared with commonly recognised computer science <a href="https://en.wikipedia.org/wiki/Sorting_algorithm">sorting algorithms</a>. This situation is due to the limitations of the aggregation domain language compared with a general-purpose programming language. The performance difference will be negligible for arrays with a small number of elements (probably up to a few tens of members). For larger arrays containing hundreds of members or more, the degradation in performance is likely to be more profound.</p>
</li>
<li>
<p><strong>Why Isnâ€™t There A Native &quot;$sortArray&quot; Operator?.</strong> As you've seen, the composite set of expressions you must generate to perform an inline sort operation on an array is complex, in addition to being computationally suboptimal. If you are writing aggregations using JavaScript for the MongoDB Shell, you can copy the function provided in this chapter. However, in most &quot;production&quot; situations, you will be using a different programming language. Consequently, you would first need to port the example macro function to your chosen programming language. Ideally, the Aggregation Framework would provide a native and optimised array operator expression for this (e.g.  called <code>$sortArray</code>), and this operator would take optional parameters to:</p>
<ol>
<li>Indicate whether the ordering should be ascending or descending (defaulting to ascending)</li>
<li>Name a field (or fields) in each array element to sort by, rather than the default of sorting by each array element &quot;as a whole&quot;</li>
</ol>
<p>You can upvote the MongoDB enhancement request &quot;<a href="https://jira.mongodb.org/browse/SERVER-29425">Add an expression to sort an array</a>&quot; if you would like to register your desire for a native sort array operator expression.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../examples/array-manipulations/pivot-array-items.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../appendices/appendices.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../examples/array-manipulations/pivot-array-items.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../appendices/appendices.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
