<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Facets And Counts Text Search - Practical MongoDB Aggregations Book</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Learn about MongoDB Aggregations to develop effective and optimal data manipulation and analytics aggregation pipelines with this book, using the MongoDB Aggregation Framework (aggregate)">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-D0T2GQ8R19"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-D0T2GQ8R19');
        </script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../front-cover.html">Practical MongoDB Aggregations</a></li><li class="chapter-item expanded affix "><a href="../../credits.html">Credits</a></li><li class="chapter-item expanded affix "><a href="../../foreword.html">Foreword</a></li><li class="chapter-item expanded affix "><a href="../../who-this-is-for.html">Who This Book Is For</a></li><li class="chapter-item expanded "><a href="../../intro/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../intro/introducing-aggregations.html"><strong aria-hidden="true">1.1.</strong> Introducing MongoDB Aggregations</a></li><li class="chapter-item expanded "><a href="../../intro/history.html"><strong aria-hidden="true">1.2.</strong> History of MongoDB Aggregations</a></li><li class="chapter-item expanded "><a href="../../intro/getting-started.html"><strong aria-hidden="true">1.3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../../intro/getting-help.html"><strong aria-hidden="true">1.4.</strong> Getting Help</a></li></ol></li><li class="chapter-item expanded "><a href="../../guides/guides.html"><strong aria-hidden="true">2.</strong> Guiding Tips & Principles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../guides/composibility.html"><strong aria-hidden="true">2.1.</strong> Embrace Composability For Increased Productivity</a></li><li class="chapter-item expanded "><a href="../../guides/project.html"><strong aria-hidden="true">2.2.</strong> Better Alternatives To A Project Stage</a></li><li class="chapter-item expanded "><a href="../../guides/explain.html"><strong aria-hidden="true">2.3.</strong> Using Explain Plans</a></li><li class="chapter-item expanded "><a href="../../guides/performance.html"><strong aria-hidden="true">2.4.</strong> Pipeline Performance Considerations</a></li><li class="chapter-item expanded "><a href="../../guides/expressions.html"><strong aria-hidden="true">2.5.</strong> Expressions Explained</a></li><li class="chapter-item expanded "><a href="../../guides/sharding.html"><strong aria-hidden="true">2.6.</strong> Sharding Considerations</a></li><li class="chapter-item expanded "><a href="../../guides/advanced-arrays.html"><strong aria-hidden="true">2.7.</strong> Advanced Use Of Expressions For Array Processing</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/examples.html"><strong aria-hidden="true">3.</strong> Aggregations By Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/foundational/foundational.html"><strong aria-hidden="true">3.1.</strong> Foundational Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/foundational/filtered-top-subset.html"><strong aria-hidden="true">3.1.1.</strong> Filtered Top Subset</a></li><li class="chapter-item expanded "><a href="../../examples/foundational/group-and-total.html"><strong aria-hidden="true">3.1.2.</strong> Group & Total</a></li><li class="chapter-item expanded "><a href="../../examples/foundational/unpack-array-group-differently.html"><strong aria-hidden="true">3.1.3.</strong> Unpack Arrays & Group Differently</a></li><li class="chapter-item expanded "><a href="../../examples/foundational/distinct-values.html"><strong aria-hidden="true">3.1.4.</strong> Distinct List Of Values</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/joining/joining.html"><strong aria-hidden="true">3.2.</strong> Joining Data Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/joining/one-to-one-join.html"><strong aria-hidden="true">3.2.1.</strong> One-to-One Join</a></li><li class="chapter-item expanded "><a href="../../examples/joining/multi-one-to-many.html"><strong aria-hidden="true">3.2.2.</strong> Multi-Field Join & One-to-Many</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/type-convert/type-convert.html"><strong aria-hidden="true">3.3.</strong> Data Types Conversion Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/type-convert/convert-to-strongly-typed.html"><strong aria-hidden="true">3.3.1.</strong> Strongly-Typed Conversion</a></li><li class="chapter-item expanded "><a href="../../examples/type-convert/convert-incomplete-dates.html"><strong aria-hidden="true">3.3.2.</strong> Convert Incomplete Date Strings</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/trend-analysis/trend-analysis.html"><strong aria-hidden="true">3.4.</strong> Trend Analysis Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/trend-analysis/faceted-classifications.html"><strong aria-hidden="true">3.4.1.</strong> Faceted Classification</a></li><li class="chapter-item expanded "><a href="../../examples/trend-analysis/largest-graph-network.html"><strong aria-hidden="true">3.4.2.</strong> Largest Graph Network</a></li><li class="chapter-item expanded "><a href="../../examples/trend-analysis/incremental-analytics.html"><strong aria-hidden="true">3.4.3.</strong> Incremental Analytics</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/securing-data/securing-data.html"><strong aria-hidden="true">3.5.</strong> Securing Data Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/securing-data/redacted-view.html"><strong aria-hidden="true">3.5.1.</strong> Redacted View</a></li><li class="chapter-item expanded "><a href="../../examples/securing-data/mask-sensitive-fields.html"><strong aria-hidden="true">3.5.2.</strong> Mask Sensitive Fields</a></li><li class="chapter-item expanded "><a href="../../examples/securing-data/role-programmatic-restricted-view.html"><strong aria-hidden="true">3.5.3.</strong> Role Programmatic Restricted View</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/time-series/time-series.html"><strong aria-hidden="true">3.6.</strong> Time-Series Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/time-series/iot-power-consumption.html"><strong aria-hidden="true">3.6.1.</strong> IoT Power Consumption</a></li><li class="chapter-item expanded "><a href="../../examples/time-series/state-change-boundaries.html"><strong aria-hidden="true">3.6.2.</strong> State Change Boundaries</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-manipulations.html"><strong aria-hidden="true">3.7.</strong> Array Manipulation Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-high-low-avg.html"><strong aria-hidden="true">3.7.1.</strong> Summarising Arrays For First, Last, Min, Max & Average</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/pivot-array-items.html"><strong aria-hidden="true">3.7.2.</strong> Pivot Array Items By A Key</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-sort-percentiles.html"><strong aria-hidden="true">3.7.3.</strong> Array Sorting & Percentiles</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-element-grouping.html"><strong aria-hidden="true">3.7.4.</strong> Array Element Grouping</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/array-fields-joining.html"><strong aria-hidden="true">3.7.5.</strong> Array Fields Joining</a></li><li class="chapter-item expanded "><a href="../../examples/array-manipulations/comparison-of-two-arrays.html"><strong aria-hidden="true">3.7.6.</strong> Comparison Of Two Arrays</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/full-text-search/full-text-search.html"><strong aria-hidden="true">3.8.</strong> Full Text Search Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/full-text-search/compound-text-search.html"><strong aria-hidden="true">3.8.1.</strong> Compound Text Search Criteria</a></li><li class="chapter-item expanded "><a href="../../examples/full-text-search/facets-and-counts-text-search.html" class="active"><strong aria-hidden="true">3.8.2.</strong> Facets And Counts Text Search</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../appendices/appendices.html"><strong aria-hidden="true">4.</strong> Appendices</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../appendices/cheatsheet.html"><strong aria-hidden="true">4.1.</strong> Appendix: Stages Cheatsheet</a></li><li class="chapter-item expanded "><a href="../../appendices/cheatsheet-source.html"><strong aria-hidden="true">4.2.</strong> Appendix: Stages Cheatsheet Source</a></li><li class="chapter-item expanded "><a href="../../appendices/create-search-index.html"><strong aria-hidden="true">4.3.</strong> Appendix: Create Atlas Search Index</a></li><li class="chapter-item expanded "><a href="../../appendices/book-history.html"><strong aria-hidden="true">4.4.</strong> Appendix: Book Version History</a></li></ol></li><li class="chapter-item expanded "><a href="../../back-cover.html"></a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Practical MongoDB Aggregations Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="facets-and-counts-text-search"><a class="header" href="#facets-and-counts-text-search">Facets And Counts Text Search</a></h1>
<p><strong>Minimum MongoDB Version:</strong> 4.4    <em>(due to use of the <a href="https://www.mongodb.com/docs/atlas/atlas-search/facet/"><code>facet</code></a> option in the <a href="https://www.mongodb.com/docs/atlas/atlas-search/query-syntax/#mongodb-pipeline-pipe.-searchMeta"><code>$searchMeta</code></a> stage)</em></p>
<h2 id="scenario"><a class="header" href="#scenario">Scenario</a></h2>
<p>You help run a bank's call centre and want to analyse the summary descriptions of customer telephone enquiries recorded by call centre staff. You want to look for customer calls that mention <em>fraud</em> and understand what periods of a specific day these fraud-related calls occur. This insight will help the bank plan its future staffing rotas for the fraud department.</p>
<blockquote>
<p><em>To execute this example, you need to be using an Atlas Cluster rather than a self-managed MongoDB deployment. The simplest way to achieve this is to <a href="https://www.mongodb.com/cloud/atlas">provision a Free Tier Atlas Cluster</a>.</em></p>
</blockquote>
<h2 id="sample-data-population"><a class="header" href="#sample-data-population">Sample Data Population</a></h2>
<p>Drop any old version of the database (if it exists) and then populate a new <em>enquiries</em> collection with new records:</p>
<pre><code class="language-javascript">db = db.getSiblingDB(&quot;book-facets-text-search&quot;);
db.enquiries.remove({});

// Insert records into the enquiries collection
db.enquiries.insertMany([
  {
    &quot;acountId&quot;: &quot;9913183&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-30T08:35:52Z&quot;),
    &quot;summary&quot;: &quot;They just made a balance enquiry only - no other issues&quot;,
  },
  {
    &quot;acountId&quot;: &quot;9913183&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-30T09:32:07Z&quot;),
    &quot;summary&quot;: &quot;Reported suspected fraud - froze cards, initiated chargeback on the transaction&quot;,
  },
  {
    &quot;acountId&quot;: &quot;6830859&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-30T10:25:37Z&quot;),
    &quot;summary&quot;: &quot;Customer said they didn't make one of the transactions which could be fraud - passed on to the investigations team&quot;,
  },
  {
    &quot;acountId&quot;: &quot;9899216&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-30T11:13:32Z&quot;),
    &quot;summary&quot;: &quot;Struggling financially this month hence requiring extended overdraft - increased limit to 500 for 2 monts&quot;,
  },  
  {
    &quot;acountId&quot;: &quot;1766583&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-30T10:56:53Z&quot;),
    &quot;summary&quot;: &quot;Fraud reported - fradulent direct debit established 3 months ago - removed instruction and reported to crime team&quot;,
  },
  {
    &quot;acountId&quot;: &quot;9310399&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-30T14:04:48Z&quot;),
    &quot;summary&quot;: &quot;Customer rang on mobile whilst fraud call in progress on home phone to check if it was valid - advised to hang up&quot;,
  },
  {
    &quot;acountId&quot;: &quot;4542001&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-30T16:55:46Z&quot;),
    &quot;summary&quot;: &quot;Enquiring for loan - approved standard loan for 6000 over 4 years&quot;,
  },
  {
    &quot;acountId&quot;: &quot;7387756&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-30T17:49:32Z&quot;),
    &quot;summary&quot;: &quot;Froze customer account when they called in as multiple fraud transactions appearing even whilst call was active&quot;,
  },
  {
    &quot;acountId&quot;: &quot;3987992&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-30T22:49:44Z&quot;),
    &quot;summary&quot;: &quot;Customer called claiming fraud for a transaction which confirmed looks suspicious and so issued chargeback&quot;,
  },
  {
    &quot;acountId&quot;: &quot;7362872&quot;,
    &quot;datetime&quot;: ISODate(&quot;2022-01-31T07:07:14Z&quot;),
    &quot;summary&quot;: &quot;Worst case of fraud I've ever seen - customer lost millions - escalated to our high value team&quot;,
  },
]);
</code></pre>
<p> </p>
<p>Now, using the simple procedure described in the <a href="../../appendices/create-search-index.html">Create Atlas Search Index</a> appendix, define a <strong>Search Index</strong>. Select the new database collection <strong>book-facets-text-search.enquiries</strong> and enter the following JSON search index definition:</p>
<pre><code class="language-javascript">{
  &quot;analyzer&quot;: &quot;lucene.english&quot;,
  &quot;searchAnalyzer&quot;: &quot;lucene.english&quot;,
  &quot;mappings&quot;: {
    &quot;dynamic&quot;: true,
    &quot;fields&quot;: {
      &quot;datetime&quot;: [
        {&quot;type&quot;: &quot;date&quot;},
        {&quot;type&quot;: &quot;dateFacet&quot;}
      ]
    }
  }
}
</code></pre>
<blockquote>
<p><em>This definition indicates that the index should use the <em>lucene-english</em> analyzer. It includes an explicit mapping for the <code>datetime</code> field to ask for the field to be indexed in two ways to simultaneously support a date range filter and faceting from the same pipeline. The mapping indicates that all other document fields will be searchable with inferred data types.</em></p>
</blockquote>
<h2 id="aggregation-pipeline"><a class="header" href="#aggregation-pipeline">Aggregation Pipeline</a></h2>
<p>Define a pipeline ready to perform the aggregation:</p>
<pre><code class="language-javascript">var pipeline = [
  // For 1 day match 'fraud' enquiries, grouped into periods of the day, counting them
  {&quot;$searchMeta&quot;: {
    &quot;index&quot;: &quot;default&quot;,    
    &quot;facet&quot;: {
      &quot;operator&quot;: {
        &quot;compound&quot;: {
          &quot;must&quot;: [
            {&quot;text&quot;: {
              &quot;path&quot;: &quot;summary&quot;,
              &quot;query&quot;: &quot;fraud&quot;,
            }},
          ],
          &quot;filter&quot;: [
            {&quot;range&quot;: {
              &quot;path&quot;: &quot;datetime&quot;,
              &quot;gte&quot;: ISODate(&quot;2022-01-30&quot;),
              &quot;lt&quot;: ISODate(&quot;2022-01-31&quot;),
            }},
          ],
        },
      },
      &quot;facets&quot;: {        
        &quot;fraudEnquiryPeriods&quot;: {
          &quot;type&quot;: &quot;date&quot;,
          &quot;path&quot;: &quot;datetime&quot;,
          &quot;boundaries&quot;: [
            ISODate(&quot;2022-01-30T00:00:00.000Z&quot;),
            ISODate(&quot;2022-01-30T06:00:00.000Z&quot;),
            ISODate(&quot;2022-01-30T12:00:00.000Z&quot;),
            ISODate(&quot;2022-01-30T18:00:00.000Z&quot;),
            ISODate(&quot;2022-01-31T00:00:00.000Z&quot;),
          ],
        }            
      }        
    }           
  }},
];
</code></pre>
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<p>Execute the aggregation using the defined pipeline and also view its explain plan:</p>
<pre><code class="language-javascript">db.enquiries.aggregate(pipeline);
</code></pre>
<p>Note, it is not currently possible to view the explain plan for a <code>$searchMeta</code> based aggregation.</p>
<h2 id="expected-results"><a class="header" href="#expected-results">Expected Results</a></h2>
<p>The results should show the pipeline matched 6 documents for a specific day on the text <code>fraud</code>, spread out over the four 6-hour periods, as shown below:</p>
<pre><code class="language-javascript">[
  {
    count: { lowerBound: Long(&quot;6&quot;) },
    facet: {
      fraudEnquiryPeriods: {
        buckets: [
          {
            _id: ISODate(&quot;2022-01-30T00:00:00.000Z&quot;),
            count: Long(&quot;0&quot;)
          },
          {
            _id: ISODate(&quot;2022-01-30T06:00:00.000Z&quot;),
            count: Long(&quot;3&quot;)
          },
          {
            _id: ISODate(&quot;2022-01-30T12:00:00.000Z&quot;),
            count: Long(&quot;2&quot;)
          },
          {
            _id: ISODate(&quot;2022-01-30T18:00:00.000Z&quot;),
            count: Long(&quot;1&quot;)
          }
        ]
      }
    }
  }
]
</code></pre>
<p>If you don't see any facet results and the value of <code>count</code> is zero, double-check that the system has finished generating your new index.</p>
<h2 id="observations"><a class="header" href="#observations">Observations</a></h2>
<ul>
<li>
<p><strong>Search Metadata Stage.</strong> The <a href="https://www.mongodb.com/docs/atlas/atlas-search/query-syntax/"><code>$searchMeta</code></a> stage is only available in aggregation pipelines run against an Atlas-based MongoDB database which leverages <a href="https://www.mongodb.com/docs/atlas/atlas-search/">Atlas Search</a>. A <code>$searchMeta</code> stage must be the first stage of an aggregation pipeline, and <a href="https://www.mongodb.com/docs/atlas/atlas-search/atlas-search-overview/#fts-architecture">under the covers</a>, it performs a text search operation against an internally synchronised Lucene full-text index. However, it is different from the <code>$search</code> operator used in the <a href="compound-text-search.html">earlier search example chapter</a>. Instead, you use <code>$searchMeta</code> to ask the system to return metadata about the text search you executed, such as the match count, rather than returning the search result records. The <code>$searchMeta</code> stage takes a <code>facet</code> option, which takes two options, <code>operator</code> and <code>facet</code>, which you use to define the text search criteria and categorise the results in groups.</p>
</li>
<li>
<p><strong>Date Range Filter.</strong> The pipeline uses a <a href="https://www.mongodb.com/docs/atlas/atlas-search/text/"><code>$text</code></a> operator for matching descriptions containing the term <em>fraud</em>. Additionally, the search criteria include a <a href="https://www.mongodb.com/docs/atlas/atlas-search/return-stored-source/"><code>$range</code></a> operator. The <code>$range</code> operator allows you to match records between two numbers or two dates. The example pipeline applies a date range, only including documents where each <code>datetime</code> field's value is <em>30-January-2022</em>. </p>
</li>
<li>
<p><strong>Facet Boundaries.</strong> The pipeline uses a <code>facet</code> <em>collector</em> to group metadata results by date range boundaries. Each boundary in the example defines a 6-hour period of the same specific day for a document's <code>datetime</code> field. A single pipeline can declare multiple facets; hence you give each facet a different name. The pipeline only defines one facet in this example, labelling it <em>fraudEnquiryPeriods</em>. When the pipeline executes, it returns the total count of matched documents and the count of matches in each facet grouping. There were no <em>fraud-related</em> enquiries between midnight and 6am, indicating that perhaps the fraud department only requires &quot;skeleton-staffing&quot; for such periods. In contrast, the period between 6am and midday shows the highest number of fraud-related enquiries, suggesting the bank dedicates additional staff to those periods.</p>
</li>
<li>
<p><strong>Faster Facet Counts.</strong> A faceted index is a special type of Lucene index optimised to compute counts of dataset categories. An application can leverage the index to offload much of the work required to analyse facets ahead of time, thus avoiding some of the latency costs when invoking a <a href="https://en.wikipedia.org/wiki/Faceted_search">faceted search</a> at runtime. Therefore use the Atlas faceted search capability if you are in a position to adopt <a href="https://www.mongodb.com/docs/atlas/atlas-search/">Atlas Search</a>, rather than using MongoDB's general-purpose faceted search capability described in an <a href="../trend-analysis/faceted-classifications.html">earlier example in this book</a>.</p>
</li>
<li>
<p><strong>Combining A Search Operation With Metadata.</strong> In this example, a pipeline uses <code>$searchMeta</code> to obtain metadata from a search (counts and facets). What if you also want the actual search results from running <code>$search</code> similar to the <a href="./compound-text-search.html">previous example</a>? You could invoke two operations from your client application, one to retrieve the search results and one to retrieve the metadata results. However, Atlas Search provides a way of obtaining both aspects within a single aggregation. Instead of using a <code>$searchMeta</code> stage, you use a <code>$search</code> stage. The pipeline <a href="https://www.mongodb.com/docs/atlas/atlas-search/facet/#search_meta-aggregation-variable">automatically stores its metadata</a> in the <code>$$SEARCH_META</code> variable, ready for you to access it via subsequent stages in the same pipeline. For example: </p>
<pre><code class="language-javascript">{&quot;$set&quot;: {&quot;mymetadata&quot;: &quot;$$SEARCH_META&quot;}}
</code></pre>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../examples/full-text-search/compound-text-search.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../appendices/appendices.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../examples/full-text-search/compound-text-search.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../appendices/appendices.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
