<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Appendix: Stages Cheatsheet Source - Practical MongoDB Aggregations Book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Learn how to develop effective and optimal data manipulation and analytics pipelines with this book, using the MongoDB Aggregation Framework">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-D0T2GQ8R19"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-D0T2GQ8R19');
        </script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../front-cover.html">Practical MongoDB Aggregations</a></li><li class="chapter-item expanded affix "><a href="../credits.html">Credits</a></li><li class="chapter-item expanded affix "><a href="../foreword.html">Foreword</a></li><li class="chapter-item expanded affix "><a href="../who-this-is-for.html">Who This Book Is For</a></li><li class="chapter-item expanded "><a href="../intro/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intro/introducing-aggregations.html"><strong aria-hidden="true">1.1.</strong> Introducing MongoDB Aggregations</a></li><li class="chapter-item expanded "><a href="../intro/history.html"><strong aria-hidden="true">1.2.</strong> History of MongoDB Aggregations</a></li><li class="chapter-item expanded "><a href="../intro/getting-started.html"><strong aria-hidden="true">1.3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../intro/getting-help.html"><strong aria-hidden="true">1.4.</strong> Getting Help</a></li></ol></li><li class="chapter-item expanded "><a href="../guides/guides.html"><strong aria-hidden="true">2.</strong> Guiding Tips &amp; Principles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guides/composibility.html"><strong aria-hidden="true">2.1.</strong> Embrace Composability For Increased Productivity</a></li><li class="chapter-item expanded "><a href="../guides/project.html"><strong aria-hidden="true">2.2.</strong> Better Alternatives To A Project Stage</a></li><li class="chapter-item expanded "><a href="../guides/explain.html"><strong aria-hidden="true">2.3.</strong> Using Explain Plans</a></li><li class="chapter-item expanded "><a href="../guides/performance.html"><strong aria-hidden="true">2.4.</strong> Pipeline Performance Considerations</a></li><li class="chapter-item expanded "><a href="../guides/expressions.html"><strong aria-hidden="true">2.5.</strong> Expressions Explained</a></li><li class="chapter-item expanded "><a href="../guides/sharding.html"><strong aria-hidden="true">2.6.</strong> Sharding Considerations</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/examples.html"><strong aria-hidden="true">3.</strong> Aggregations By Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/foundational/foundational.html"><strong aria-hidden="true">3.1.</strong> Foundational Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/foundational/filtered-top-subset.html"><strong aria-hidden="true">3.1.1.</strong> Filtered Top Subset</a></li><li class="chapter-item expanded "><a href="../examples/foundational/group-and-total.html"><strong aria-hidden="true">3.1.2.</strong> Group &amp; Total</a></li><li class="chapter-item expanded "><a href="../examples/foundational/unpack-array-group-differently.html"><strong aria-hidden="true">3.1.3.</strong> Unpack Arrays &amp; Group Differently</a></li><li class="chapter-item expanded "><a href="../examples/foundational/distinct-values.html"><strong aria-hidden="true">3.1.4.</strong> Distinct List Of Values</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/joining/joining.html"><strong aria-hidden="true">3.2.</strong> Joining Data Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/joining/one-to-one-join.html"><strong aria-hidden="true">3.2.1.</strong> One-to-One Join</a></li><li class="chapter-item expanded "><a href="../examples/joining/multi-one-to-many.html"><strong aria-hidden="true">3.2.2.</strong> Multi-Field Join &amp; One-to-Many</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/type-convert/type-convert.html"><strong aria-hidden="true">3.3.</strong> Data Types Conversion Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/type-convert/convert-to-strongly-typed.html"><strong aria-hidden="true">3.3.1.</strong> Strongly-Typed Conversion</a></li><li class="chapter-item expanded "><a href="../examples/type-convert/convert-incomplete-dates.html"><strong aria-hidden="true">3.3.2.</strong> Convert Incomplete Date Strings</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/trend-analysis/trend-analysis.html"><strong aria-hidden="true">3.4.</strong> Trend Analysis Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/trend-analysis/faceted-classifications.html"><strong aria-hidden="true">3.4.1.</strong> Faceted Classification</a></li><li class="chapter-item expanded "><a href="../examples/trend-analysis/largest-graph-network.html"><strong aria-hidden="true">3.4.2.</strong> Largest Graph Network</a></li><li class="chapter-item expanded "><a href="../examples/trend-analysis/incremental-analytics.html"><strong aria-hidden="true">3.4.3.</strong> Incremental Analytics</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/securing-data/securing-data.html"><strong aria-hidden="true">3.5.</strong> Securing Data Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/securing-data/restricted-view.html"><strong aria-hidden="true">3.5.1.</strong> Restricted View</a></li><li class="chapter-item expanded "><a href="../examples/securing-data/mask-sensitive-fields.html"><strong aria-hidden="true">3.5.2.</strong> Mask Sensitive Fields</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/time-series/time-series.html"><strong aria-hidden="true">3.6.</strong> Time-Series Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/time-series/iot-power-consumption.html"><strong aria-hidden="true">3.6.1.</strong> IoT Power Consumption</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../appendices/appendices.html"><strong aria-hidden="true">4.</strong> Appendices</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendices/cheatsheet.html"><strong aria-hidden="true">4.1.</strong> Appendix: Stages Cheatsheet</a></li><li class="chapter-item expanded "><a href="../appendices/cheatsheet-source.html" class="active"><strong aria-hidden="true">4.2.</strong> Appendix: Stages Cheatsheet Source</a></li><li class="chapter-item expanded "><a href="../appendices/book-history.html"><strong aria-hidden="true">4.3.</strong> Appendix: Book Version History</a></li></ol></li><li class="chapter-item expanded "><a href="../back-cover.html"></a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Practical MongoDB Aggregations Book</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="stages-cheatsheet-source"><a class="header" href="#stages-cheatsheet-source">Stages Cheatsheet Source</a></h1>
<p>To test all the aggregation stage examples shown in the <a href="cheatsheet.html">Cheatsheet</a>, run the following JavaScript from the MongoDB Shell connected to a MongoDB database.</p>
<h2 id="collections-configuration--data-population"><a class="header" href="#collections-configuration--data-population">Collections Configuration &amp; Data Population</a></h2>
<pre><code class="language-javascript">// DB configuration
use cheatsheet;
db.dropDatabase();
db.places.createIndex({loc: &quot;2dsphere&quot;});

// 'shapes' collection
db.shapes.insertMany([
  {_id: &quot;◐&quot;, x: &quot;■&quot;, y: &quot;▲&quot;, val: 11},
  {_id: &quot;◑&quot;, x: &quot;■&quot;, y: &quot;■&quot;, val: 74},
  {_id: &quot;◒&quot;, x: &quot;●&quot;, y: &quot;■&quot;, val: 79},
  {_id: &quot;◓&quot;, x: &quot;▲&quot;, y: &quot;▲&quot;, val: 81},
  {_id: &quot;◔&quot;, x: &quot;■&quot;, y: &quot;▲&quot;, val: 83},
  {_id: &quot;◕&quot;, x: &quot;●&quot;, y: &quot;■&quot;, val: 85},
]);

// 'lists' collection
db.lists.insertMany([
  {_id: &quot;▤&quot;, a: &quot;●&quot;, b: [&quot;◰&quot;, &quot;◱&quot;]},
  {_id: &quot;▥&quot;, a: &quot;▲&quot;, b: [&quot;◲&quot;]},
  {_id: &quot;▦&quot;, a: &quot;▲&quot;, b: [&quot;◰&quot;, &quot;◳&quot;, &quot;◱&quot;]},
  {_id: &quot;▧&quot;, a: &quot;●&quot;, b: [&quot;◰&quot;]},
  {_id: &quot;▨&quot;, a: &quot;■&quot;, b: [&quot;◳&quot;, &quot;◱&quot;]},
]);

// 'places' collection
db.places.insertMany([
  {_id: &quot;◧&quot;, loc: {type: &quot;Point&quot;, coordinates: [1,1]}},
  {_id: &quot;◨&quot;, loc: {type: &quot;Point&quot;, coordinates: [3,3]}},
  {_id: &quot;◩&quot;, loc: {type: &quot;Point&quot;, coordinates: [5,5]}},
  {_id: &quot;◪&quot;, loc: {type: &quot;LineString&quot;, coordinates: [[7,7],[8,8]]}},
]);
</code></pre>
<h2 id="aggregation-stage-examples"><a class="header" href="#aggregation-stage-examples">Aggregation Stage Examples</a></h2>
<blockquote>
<p><em>Some of these stages apply to later versions of MongoDB only (e.g. 4.4, 5.0). Each stage is marked with the minimum version of MongoDB (shown in brackets). Therefore if you are running an earlier version, first comment out the appropriate &quot;JavaScript stage sections&quot; before executing the code.</em></p>
</blockquote>
<pre><code class="language-javascript">// $addFields  (v3.4)
db.shapes.aggregate([
  {&quot;$addFields&quot;: {&quot;z&quot;: &quot;●&quot;}}
]);


// $bucket  (v3.4)
db.shapes.aggregate([
  {&quot;$bucket&quot;: {
    &quot;groupBy&quot;: &quot;$val&quot;, &quot;boundaries&quot;: [0, 25, 50, 75, 100], &quot;default&quot;: &quot;Other&quot;
  }}
]);


// $bucketAuto  (v3.4)
db.shapes.aggregate([
  {&quot;$bucketAuto&quot;: {&quot;groupBy&quot;: &quot;$val&quot;, &quot;buckets&quot;: 3}}
]);


// $count  (v3.4)
db.shapes.aggregate([
  {&quot;$count&quot;: &quot;amount&quot;}
]);


// $facet  (v3.4)
db.shapes.aggregate([
  {&quot;$facet&quot;: {
    &quot;X_CIRCLE_FACET&quot;: [{&quot;$match&quot;: {&quot;x&quot;: &quot;●&quot;}}],
    &quot;FIRST_TWO_FACET&quot; : [{&quot;$limit&quot;: 2}],
  }}
]);


// $geoNear  (v2.2)
db.places.aggregate([
  {&quot;$geoNear&quot;: {
    &quot;near&quot;: {&quot;type&quot;: &quot;Point&quot;, &quot;coordinates&quot;: [9,9]}, &quot;distanceField&quot;: &quot;distance&quot;
  }}
]);


// $graphLookup  (v3.4)
db.shapes.aggregate([
  {&quot;$graphLookup&quot;: {
    &quot;from&quot;: &quot;shapes&quot;,
    &quot;startWith&quot;: &quot;$x&quot;,
    &quot;connectFromField&quot;: &quot;x&quot;,
    &quot;connectToField&quot;: &quot;y&quot;,
    &quot;depthField&quot;: &quot;depth&quot;,
    &quot;as&quot;: &quot;connections&quot;,
  }},
  {$project: {&quot;connections_count&quot;: {&quot;$size&quot;: &quot;$connections&quot;}}}
]);


// $group  (v2.2)
db.shapes.aggregate([
  {&quot;$group&quot;: {&quot;_id&quot;: &quot;$x&quot;, &quot;ylist&quot;: {&quot;$push&quot;: &quot;$y&quot;}}}
]);


// $limit  (v2.2)
db.shapes.aggregate([
  {&quot;$limit&quot;: 2}
]);


// $lookup  (v3.2)
db.shapes.aggregate([
  {&quot;$lookup&quot;: {
    &quot;from&quot;: &quot;lists&quot;,
    &quot;localField&quot;: &quot;y&quot;,
    &quot;foreignField&quot;: &quot;a&quot;,
    &quot;as&quot;: &quot;refs&quot;,
  }}
]);


// $match  (v2.2)
db.shapes.aggregate([
  {&quot;$match&quot;: {&quot;y&quot;: &quot;▲&quot;}  
}]);


// $merge  (v4.2)
db.results.drop();
db.shapes.aggregate([
  {&quot;$merge&quot;: {&quot;into&quot;: &quot;results&quot;}}
]);
db.results.find();


// $out  (v2.6)
db.results.drop();
db.shapes.aggregate([
  {&quot;$out&quot;: &quot;results&quot;}
]);
db.results.find();


// $project  (v2.2)
db.shapes.aggregate([
  {&quot;$project&quot;: {&quot;x&quot;: 1}}
]);


// $redact  (v2.6)
db.places.aggregate([
  {&quot;$redact&quot;: {&quot;$cond&quot;: {
    &quot;if&quot;  : {&quot;$eq&quot;: [&quot;$type&quot;, &quot;LineString&quot;]},
    &quot;then&quot;: &quot;$$PRUNE&quot;,
    &quot;else&quot;: &quot;$$DESCEND&quot;
  }}}
]);


// $replaceRoot  (v3.4)
db.lists.aggregate([
  {&quot;$replaceRoot&quot;: {&quot;newRoot&quot;: {&quot;first&quot;: {&quot;$first&quot;: &quot;$b&quot;}, &quot;last&quot;: {&quot;$last&quot;: &quot;$b&quot;}}}}
]);


// $replaceWith  (v4.2)
db.lists.aggregate([
  {&quot;$replaceWith&quot;: {&quot;first&quot;: {&quot;$first&quot;: &quot;$b&quot;}, &quot;last&quot;: {&quot;$last&quot;: &quot;$b&quot;}}}
]);


// $sample  (v3.2)
db.shapes.aggregate([
  {&quot;$sample&quot;: {&quot;size&quot;: 3}}
]);


// $set  (v4.2)
db.shapes.aggregate([
  {&quot;$set&quot;: {&quot;y&quot;: &quot;▲&quot;}}
]);


// $setWindowFields  (v5.0)
db.shapes.aggregate([
  {&quot;$setWindowFields&quot;: {
    &quot;partitionBy&quot;: &quot;$x&quot;,
    &quot;sortBy&quot;: {&quot;_id&quot;: 1},    
    &quot;output&quot;: {
      &quot;cumulativeValShapeX&quot;: {
        &quot;$sum&quot;: &quot;$val&quot;,
        &quot;window&quot;: {
          &quot;documents&quot;: [&quot;unbounded&quot;, &quot;current&quot;]
        }
      }
    }
  }}
]);


// $skip  (v2.2)
db.shapes.aggregate([
  {&quot;$skip&quot;: 5}
]);


// $sort  (v2.2)
db.shapes.aggregate([
  {&quot;$sort&quot;: {&quot;x&quot;: 1, &quot;y&quot;: 1}}
]);


// $sortByCount  (v3.4)
db.shapes.aggregate([
  {&quot;$sortByCount&quot;: &quot;$x&quot;}
]);


// $unionWith  (v4.4)
db.shapes.aggregate([
  {&quot;$unionWith&quot;: {&quot;coll&quot;: &quot;lists&quot;}}
]);


// $unset  (v4.2)
db.shapes.aggregate([
  {&quot;$unset&quot;: [&quot;x&quot;]}
]);


// $unwind  (v2.2)
db.lists.aggregate([
  {&quot;$unwind&quot;: {&quot;path&quot;: &quot;$b&quot;}}
]);
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../appendices/cheatsheet.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../appendices/book-history.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../appendices/cheatsheet.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../appendices/book-history.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
